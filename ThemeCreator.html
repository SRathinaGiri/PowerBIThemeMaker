<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Finance BI Master Theme Pro - Validated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        :root { --accent: #1F6FFF; }
        .tab-active { border-bottom: 4px solid var(--accent); color: var(--accent); font-weight: bold; }
        .config-table { width: 100%; border-collapse: collapse; font-size: 11px; background: white; }
        .config-table th, .config-table td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
        .config-table th { background: #f8fafc; color: #475569; text-transform: uppercase; width: 30%; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .color-input-ui { @apply w-8 h-8 rounded cursor-pointer border border-slate-200 hover:scale-110 transition-all; }
        .chart-container { width: 100%; height: 260px; min-height: 260px; background: transparent; border-radius: 8px; }
    </style>
</head>
<body class="p-4 font-sans text-sm transition-colors duration-500">
    <div class="max-w-7xl mx-auto shadow-2xl rounded-2xl overflow-hidden flex flex-col h-[92vh] border border-slate-300 bg-white">
        
        <div class="bg-slate-900 text-white p-6 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black text-blue-400">Finance BI <span class="text-white font-light">Theme Master</span></h1>
                <input type="text" id="clientName" value="Finance BI – Master Visual Palettes (Light) – v3e" class="bg-slate-800 border-none text-white text-xs w-80 mt-2 p-2 rounded">
            </div>
            <div class="flex gap-3">
                <button onclick="updateAll()" class="bg-slate-700 hover:bg-slate-600 px-4 py-3 rounded-lg font-bold text-white transition-all">Render Preview</button>
                <button onclick="downloadJSON()" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-bold shadow-xl text-white transition-all">Export Theme JSON</button>
            </div>
        </div>

        <div class="bg-white border-b flex px-8">
            <button onclick="showTab('preview')" id="btn-preview" class="px-6 py-4 tab-active">Live Dashboard</button>
            <button onclick="showTab('global')" id="btn-global" class="px-6 py-4">Global & Palettes</button>
            <button onclick="showTab('visuals')" id="btn-visuals" class="px-6 py-4">Visual Details</button>
            <button onclick="showTab('json')" id="btn-json" class="px-6 py-4 font-mono text-xs text-slate-400">JSON View</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
            <div id="tab-preview" class="tab-content active">
                <div id="canvas" class="p-8 rounded-xl border transition-all duration-500">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="preview-card p-4 shadow-sm rounded-lg border"><div id="barChart" class="chart-container"></div></div>
                        <div class="preview-card p-4 shadow-sm rounded-lg border"><div id="lineChart" class="chart-container"></div></div>
                        <div class="preview-card p-4 shadow-sm rounded-lg border"><div id="pieChart" class="chart-container"></div></div>
                        <div class="preview-card p-6 shadow-sm rounded-lg border col-span-full">
                            <table class="w-full text-left border-collapse text-xs" id="previewTable">
                                <thead id="tableHead"><tr><th class="p-3">Entity</th><th class="p-3">Audit Score</th><th class="p-3">Value</th><th class="p-3">Status</th></tr></thead>
                                <tbody>
                                    <tr id="rowPri"><td class="p-3 border-b">Corporate HQ</td><td class="p-3 border-b">94%</td><td class="p-3 border-b">₹4,50,000</td><td class="p-3 border-b text-green-600 font-bold">Good</td></tr>
                                    <tr id="rowSec"><td class="p-3 border-b">Regional Office</td><td class="p-3 border-b">12%</td><td class="p-3 border-b">₹1,20,000</td><td class="p-3 border-b text-yellow-600 font-bold">Neutral</td></tr>
                                </tbody>
                                <tfoot id="tableTotal"><tr><td class="p-3 font-bold" colspan="2">Consolidated Total</td><td class="p-3 font-bold" colspan="2">₹5,70,000</td></tr></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-global" class="tab-content">
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <div class="grid grid-cols-3 gap-8 mb-6">
                        <div><label class="block text-[10px] font-bold uppercase mb-1">Mode</label>
                        <select id="baseMode" onchange="setModeDefaults()" class="w-full p-2 border rounded bg-white"><option value="light">Light Theme</option><option value="dark">Dark Theme</option></select></div>
                        <div><label class="block text-[10px] font-bold uppercase mb-1 flex justify-between">Accent <span class="flex items-center gap-1 font-normal lowercase text-[9px]"><input type="checkbox" id="autoSync" checked> sync bg/fg</span></label>
                        <input type="color" id="primaryColor" value="#1F6FFF" onchange="syncThemeFromAccent(); updateAll()" class="w-full h-10 rounded cursor-pointer"></div>
                        <div><label class="block text-[10px] font-bold uppercase mb-1">Bg Brightness</label>
                        <input type="range" id="bgBrightness" min="-20" max="30" value="0" step="1" oninput="syncThemeFromAccent(); updateAll()" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer mt-3"></div>
                    </div>
                    <div class="grid grid-cols-5 gap-4 mb-6">
                        <div><label class="block text-[10px] font-bold uppercase mb-1">Good</label>
                        <input type="color" id="statusGood" value="#00A36C" onchange="updateAll()" class="w-full h-8 rounded cursor-pointer"></div>
                        <div><label class="block text-[10px] font-bold uppercase mb-1">Neutral</label>
                        <input type="color" id="statusNeutral" value="#FFB000" onchange="updateAll()" class="w-full h-8 rounded cursor-pointer"></div>
                        <div><label class="block text-[10px] font-bold uppercase mb-1">Bad</label>
                        <input type="color" id="statusBad" value="#E05656" onchange="updateAll()" class="w-full h-8 rounded cursor-pointer"></div>
                        <div><label class="block text-[10px] font-bold uppercase mb-1">Page BG</label>
                        <input type="color" id="pageBg" value="#F5F7FA" onchange="updateAll()" class="w-full h-8 rounded cursor-pointer"></div>
                        <div><label class="block text-[10px] font-bold uppercase mb-1">Foreground</label>
                        <input type="color" id="pageFg" value="#2C3E50" onchange="updateAll()" class="w-full h-8 rounded cursor-pointer"></div>
                    </div>
                    <div id="paletteInspector" class="flex flex-wrap gap-3 p-4 bg-slate-50 rounded border"></div>
                </div>
                <div id="paletteGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3"></div>
            </div>

            <div id="tab-visuals" class="tab-content">
                <div class="bg-white rounded-xl border overflow-hidden space-y-4 p-4">
                    <table class="config-table">
                        <tr><th colspan="2" class="bg-slate-100 p-2 text-blue-800">General Visual Settings</th></tr>
                        <tr><td>Font Face</td><td><select id="masterFont" onchange="updateAll()" class="p-2 border rounded w-full"><option value="Arial">Arial</option><option value="Segoe UI">Segoe UI</option><option value="Calibri">Calibri</option></select></td></tr>
                        <tr><td>Borders</td><td><div class="flex items-center gap-4"><span>Show:</span><input type="checkbox" id="showBorders" onchange="updateAll()"> <span>Radius:</span><input type="number" id="borderRadius" value="12" onchange="updateAll()" class="w-20 p-2 border rounded"> <span>Color:</span><input type="color" id="borderColor" value="#E5EAF0" onchange="updateAll()" class="color-input-ui w-6 h-6"></div></td></tr>
                        <tr><td>Visual Header</td><td><div class="flex gap-4"><label><input type="checkbox" id="showHeaderTooltip" onchange="updateAll()" checked> Tooltip Button</label> <label><input type="checkbox" id="showHeaderOptions" onchange="updateAll()"> Options Menu</label></div></td></tr>
                    </table>

                    <table class="config-table">
                        <tr><th colspan="2" class="bg-slate-100 p-2 text-blue-800">Table & Matrix Settings</th></tr>
                        <tr><td>Grid</td><td><div class="flex items-center gap-4"><label><input type="checkbox" id="showGrid" onchange="updateAll()" checked> Show Lines</label> <span>Padding:</span><input type="number" id="gridPadding" value="2" onchange="updateAll()" class="w-16 p-1 border rounded"> <span>Text Size:</span><input type="number" id="gridTextSize" value="10" onchange="updateAll()" class="w-16 p-1 border rounded"></div></td></tr>
                        <tr><td>Table Options</td><td><div class="flex gap-4"><label><input type="checkbox" id="bandedRows" onchange="updateAll()" checked> Banded Rows</label> <label><input type="checkbox" id="urlIcon" onchange="updateAll()" checked> URL Icon</label> <label><input type="checkbox" id="wordWrap" onchange="updateAll()" checked> Word Wrap</label> <label><input type="checkbox" id="autoSizeCol" onchange="updateAll()" checked> Auto Size</label></div></td></tr>
                        <tr><td>Row Colors</td><td><div class="flex items-center gap-4"><span>Bg:</span><input type="color" id="tableBg" value="#F8FAFC" onchange="updateAll()" class="color-input-ui w-6 h-6"> <span>Text:</span><input type="color" id="tableFg" value="#2C3E50" onchange="updateAll()" class="color-input-ui w-6 h-6"> <span>Banded:</span><input type="color" id="tableBanded" value="#F1F5F9" onchange="updateAll()" class="color-input-ui w-6 h-6"></div></td></tr>
                        <tr><td>Contrast</td><td><div class="flex items-center gap-4"><label><input type="checkbox" id="headerContrast" onchange="updateAll()"> Headers</label><label><input type="checkbox" id="totalContrast" onchange="updateAll()"> Totals</label></div></td></tr>
                        <tr><td>Matrix Layout</td><td><div class="flex items-center gap-4"><label><input type="checkbox" id="steppedLayout" onchange="updateAll()" checked> Stepped</label> <span>Indent:</span><input type="number" id="steppedIndent" value="14" onchange="updateAll()" class="w-16 p-1 border rounded"></div></td></tr>
                        <tr><td>Matrix Subtotals</td><td><div class="flex gap-4"><label><input type="checkbox" id="rowSubtotals" onchange="updateAll()" checked> Row Subtotals</label> <label><input type="checkbox" id="colSubtotals" onchange="updateAll()" checked> Column Subtotals</label></div></td></tr>
                    </table>

                    <table class="config-table">
                        <tr><th colspan="2" class="bg-slate-100 p-2 text-blue-800">Slicer Settings</th></tr>
                        <tr><td>Header Style</td><td><label><input type="checkbox" id="slicerHeaderContrast" onchange="updateAll()"> Contrast Header</label></td></tr>
                        <tr><td>Item Colors</td><td><div class="flex items-center gap-4"><span>Hover:</span><input type="color" id="slicerHoverColor" value="#F2F5FA" onchange="updateAll()" class="color-input-ui w-6 h-6"> <span>Selected:</span><input type="color" id="slicerSelectedColor" value="#DDE7FF" onchange="updateAll()" class="color-input-ui w-6 h-6"> <span>Slider:</span><input type="color" id="slicerSliderColor" value="#E2E8F0" onchange="updateAll()" class="color-input-ui w-6 h-6"></div></td></tr>
                    </table>

                    <table class="config-table">
                        <tr><th colspan="2" class="bg-slate-100 p-2 text-blue-800">Chart Settings</th></tr>
                        <tr><td>Legend</td><td><div class="flex items-center gap-4"><label><input type="checkbox" id="chartLegendShow" onchange="updateAll()" checked> Show</label> <span>Position:</span><select id="chartLegendPos" onchange="updateAll()" class="p-1 border rounded"><option value="Top">Top</option><option value="Bottom">Bottom</option><option value="Left">Left</option><option value="Right">Right</option></select></div></td></tr>
                        <tr><td>Data Labels</td><td><div class="flex items-center gap-4"><label><input type="checkbox" id="chartLabelsShow" onchange="updateAll()" checked> Show</label> <span>Position:</span><select id="chartLabelsPos" onchange="updateAll()" class="p-1 border rounded"><option value="InsideEnd">InsideEnd</option><option value="OutsideEnd">OutsideEnd</option><option value="Center">Center</option></select> <span>Color:</span><input type="color" id="chartLabelsColor" value="#2C3E50" onchange="updateAll()" class="color-input-ui w-6 h-6"></div></td></tr>
                        <tr><td>Axes</td><td><div class="flex flex-col gap-2">
                            <div class="flex items-center gap-4"><span class="font-bold w-12">X-Axis:</span> <label><input type="checkbox" id="xAxisShow" onchange="updateAll()" checked> Show</label> <label><input type="checkbox" id="xAxisGrid" onchange="updateAll()" checked> Grid</label> <input type="color" id="xAxisGridColor" value="#E5EAF0" onchange="updateAll()" class="color-input-ui w-5 h-5" title="Grid Color"> <input type="color" id="xAxisLabelColor" value="#2C3E50" onchange="updateAll()" class="color-input-ui w-5 h-5" title="Label Color"></div>
                            <div class="flex items-center gap-4"><span class="font-bold w-12">Y-Axis:</span> <label><input type="checkbox" id="yAxisShow" onchange="updateAll()" checked> Show</label> <label><input type="checkbox" id="yAxisGrid" onchange="updateAll()" checked> Grid</label> <input type="color" id="yAxisGridColor" value="#E5EAF0" onchange="updateAll()" class="color-input-ui w-5 h-5" title="Grid Color"> <input type="color" id="yAxisLabelColor" value="#2C3E50" onchange="updateAll()" class="color-input-ui w-5 h-5" title="Label Color"></div>
                        </div></td></tr>
                    </table>
                </div>
            </div>

            <div id="tab-json" class="tab-content h-full">
                <pre id="jsonOut" class="bg-slate-900 text-blue-300 p-6 rounded-xl h-[500px] overflow-auto font-mono text-[10px]"></pre>
            </div>
        </div>

        <div class="bg-slate-100 border-t p-2 text-center text-xs text-slate-500">
            Created by S. Rathinagiri | <a href="https://github.com/SRathinaGiri/PowerBIThemeMaker" target="_blank" class="text-blue-600 hover:underline">View on GitHub</a>
        </div>
    </div>

<script>
let chartsInstance = { bar: null, line: null, pie: null };
let selectedIdx = 0;
let customColors = []; 
const statusCols = { good: "#00A36C", neutral: "#FFB000", bad: "#E05656" };

const paletteGroups = {
    "Power BI Native": [
        { name: "Default (Cypress)", colors: ["#01B8AA", "#374649", "#FD625E", "#F2C80F", "#5F6B6D", "#8AD4EB", "#FE9666", "#A66999"] },
        { name: "City Park", colors: ["#73B761", "#4A588A", "#ECC846", "#CD4C46", "#71AFE2", "#8D6FD1", "#EE9E64", "#95DABB"] },
        { name: "Classroom", colors: ["#4A8DDC", "#4C5D8A", "#F3C911", "#DC5B57", "#33AE81", "#95C8F0", "#DD915F", "#9A64A0"] },
        { name: "Colorblind Safe", colors: ["#074650", "#009292", "#FE6DB6", "#FEB5DA", "#480091", "#B66DFF", "#B5DAFE", "#6DB6FF"] },
        { name: "Electric", colors: ["#118DFF", "#750985", "#C83D95", "#FF985E", "#1DD5EE", "#42F7C0", "#3049AD", "#F64F5C"] },
        { name: "High Contrast", colors: ["#107C10", "#002050", "#A80000", "#5C2D91", "#004B50", "#0078D7", "#D83B01", "#B4009E"] },
        { name: "Sunset", colors: ["#B6B0FF", "#3049AD", "#FF994E", "#C83D95", "#FFBBED", "#42F9F9", "#00B2D9", "#FFD86C"] },
        { name: "Twilight", colors: ["#F17925", "#004753", "#CCAA14", "#4B4C4E", "#D82C20", "#A3D0D4", "#536F18", "#46ABB0"] }
    ],
    "Cool": [
        { name: "Nordic Teal", colors: ["#264653", "#2A9D8F", "#E9C46A", "#F4A261", "#E76F51", "#21867A", "#D1A142", "#C45B41"] },
        { name: "Oceanic", colors: ["#005F73", "#0A9396", "#94D2BD", "#E9D8A6", "#EE9B00", "#CA6702", "#BB3E03", "#AE2012"] },
        { name: "Midnight", colors: ["#3D5A80", "#98C1D9", "#E0FBFC", "#EE6C4D", "#293241", "#566E8D", "#778DA9", "#1B263B"] },
        { name: "Winter Blue", colors: ["#0077B6", "#0096C7", "#00B4D8", "#48CAE4", "#90E0EF", "#ADE8F4", "#CAF0F8", "#EDF6F9"] }
    ],
    "Warm": [
        { name: "Sunset Drive", colors: ["#F94144", "#F3722C", "#F8961E", "#F9844A", "#F9C74F", "#90BE6D", "#43AA8B", "#4D908E"] },
        { name: "Autumn Leaves", colors: ["#D62828", "#F77F00", "#FCBF49", "#EAE2B7", "#A4161A", "#BA181B", "#E5383B", "#F5CB5C"] },
        { name: "Desert Sand", colors: ["#A47148", "#BC8A5F", "#DDA15E", "#E9C46A", "#F4A261", "#E76F51", "#C45B41", "#BB3E03"] }
    ],
    "Contrast": [
        { name: "High Contrast", colors: ["#000000", "#FFD700", "#FF4500", "#1E90FF", "#32CD32", "#8A2BE2", "#FF1493", "#FFFFFF"] },
        { name: "Vibrant Hub", colors: ["#F72585", "#7209B7", "#3A0CA3", "#4361EE", "#4CC9F0", "#480CA8", "#560BAD", "#B5179E"] },
        { name: "Neon Lights", colors: ["#FF00FF", "#00FFFF", "#FFFF00", "#00FF00", "#FF0000", "#0000FF", "#FFFFFF", "#808080"] }
    ],
    "Modern": [
        { name: "Slate Grey", colors: ["#212529", "#343A40", "#495057", "#6C757D", "#ADB5BD", "#CED4DA", "#DEE2E6", "#F8F9FA"] },
        { name: "Tailwind Blues", colors: ["#1E3A8A", "#1D4ED8", "#2563EB", "#3B82F6", "#60A5FA", "#93C5FD", "#BFDBFE", "#DBEAFE"] },
        { name: "Dracula", colors: ["#282A36", "#44475A", "#F8F8F2", "#6272A4", "#8BE9FD", "#50FA7B", "#FFB86C", "#FF79C6"] }
    ],
    "Gradient (2 Colors)": [
        { name: "Blue to Red", colors: generateGradient(["#0000FF", "#FF0000"], 8) },
        { name: "Purple to Green", colors: generateGradient(["#800080", "#008000"], 8) },
        { name: "Orange to Cyan", colors: generateGradient(["#FFA500", "#00FFFF"], 8) },
        { name: "Deep Sea", colors: generateGradient(["#0f2027", "#2c5364"], 8) }
    ],
    "Gradient (3 Colors)": [
        { name: "Thermal", colors: generateGradient(["#0000FF", "#FFFFFF", "#FF0000"], 8) },
        { name: "Traffic", colors: generateGradient(["#00FF00", "#FFFF00", "#FF0000"], 8) },
        { name: "Sunset", colors: generateGradient(["#2c3e50", "#fd746c", "#ff9068"], 8) }
    ],
    "Single Color": [
        { name: "Blue Scale", colors: generateGradient(["#000050", "#add8e6"], 8) },
        { name: "Red Scale", colors: generateGradient(["#500000", "#ffcccb"], 8) },
        { name: "Green Scale", colors: generateGradient(["#004000", "#90ee90"], 8) },
        { name: "Grey Scale", colors: generateGradient(["#202020", "#e0e0e0"], 8) }
    ],
    "Nature": [
        { name: "Forest", colors: ["#2d4c3b", "#4a7c59", "#7fb069", "#d3f8e2", "#8c6057", "#a67f59", "#e8d6cb", "#bfd7ea"] },
        { name: "Oceanic Deep", colors: ["#00334e", "#145374", "#5588a3", "#e8e8e8", "#004e66", "#007a7a", "#7a9e9f", "#b8d8d8"] },
        { name: "Earth Tones", colors: ["#5d4037", "#795548", "#8d6e63", "#a1887f", "#bcaaa4", "#d7ccc8", "#efebe9", "#3e2723"] },
        { name: "Floral", colors: ["#e91e63", "#d81b60", "#c2185b", "#ad1457", "#880e4f", "#f48fb1", "#f06292", "#ec407a"] }
    ],
    "Corporate": [
        { name: "Executive", colors: ["#1a237e", "#283593", "#303f9f", "#3949ab", "#3f51b5", "#5c6bc0", "#7986cb", "#9fa8da"] },
        { name: "Trust", colors: ["#0d47a1", "#1565c0", "#1976d2", "#1e88e5", "#2196f3", "#42a5f5", "#64b5f6", "#90caf9"] },
        { name: "Innovation", colors: ["#01579b", "#0277bd", "#0288d1", "#039be5", "#03a9f4", "#29b6f6", "#4fc3f7", "#81d4fa"] },
        { name: "Stability", colors: ["#263238", "#37474f", "#455a64", "#546e7a", "#607d8b", "#78909c", "#90a4ae", "#b0bec5"] },
        { name: "Growth", colors: ["#1b5e20", "#2e7d32", "#388e3c", "#43a047", "#4caf50", "#66bb6a", "#81c784", "#a5d6a7"] }
    ],
    "Vibrant": [
        { name: "Retro Wave", colors: ["#3f51b5", "#e91e63", "#00bcd4", "#ffeb3b", "#ff9800", "#ff5722", "#795548", "#607d8b"] },
        { name: "Neon Cyber", colors: ["#f50057", "#d500f9", "#651fff", "#3d5afe", "#2979ff", "#00b0ff", "#00e5ff", "#1de9b6"] },
        { name: "Candy Pop", colors: ["#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4"] },
        { name: "Festival", colors: ["#d50000", "#c51162", "#aa00ff", "#6200ea", "#304ffe", "#2962ff", "#0091ea", "#00b8d4"] },
        { name: "Arcade", colors: ["#ff6d00", "#ffab00", "#ffd600", "#aeea00", "#64dd17", "#00c853", "#00bfa5", "#00b8d4"] }
    ],
    "Pastel": [
        { name: "Soft Dreams", colors: ["#ffcdd2", "#f8bbd0", "#e1bee7", "#d1c4e9", "#c5cae9", "#bbdefb", "#b3e5fc", "#b2ebf2"] },
        { name: "Cotton Candy", colors: ["#ff8a80", "#ff80ab", "#ea80fc", "#b388ff", "#8c9eff", "#82b1ff", "#80d8ff", "#84ffff"] },
        { name: "Mint Fresh", colors: ["#b9f6ca", "#ccff90", "#f4ff81", "#ffff8d", "#ffe57f", "#ffd180", "#ff9e80", "#a7ffeb"] },
        { name: "Baby Blue", colors: ["#e3f2fd", "#bbdefb", "#90caf9", "#64b5f6", "#42a5f5", "#2196f3", "#1e88e5", "#1976d2"] }
    ]
};

const palettes = Object.values(paletteGroups).flat();

function hexToRgb(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return { r, g, b };
}

function rgbToHex(r, g, b) {
    return "#" + [r, g, b].map(x => {
        const hex = Math.round(x).toString(16).padStart(2, '0');
        return hex;
    }).join('').toUpperCase();
}

function adjustBrightness(hex, percent) {
    const { r, g, b } = hexToRgb(hex);
    const amount = Math.floor(255 * (percent / 100));
    const newR = Math.max(0, Math.min(255, r + amount));
    const newG = Math.max(0, Math.min(255, g + amount));
    const newB = Math.max(0, Math.min(255, b + amount));
    return rgbToHex(newR, newG, newB);
}

function interpolateColor(color1, color2, factor) {
    const c1 = hexToRgb(color1);
    const c2 = hexToRgb(color2);
    const r = c1.r + factor * (c2.r - c1.r);
    const g = c1.g + factor * (c2.g - c1.g);
    const b = c1.b + factor * (c2.b - c1.b);
    return rgbToHex(r, g, b);
}

function generateGradient(colors, steps) {
    const gradient = [];
    if (colors.length < 2) return colors;

    if (colors.length === 2) {
        for (let i = 0; i < steps; i++) {
            gradient.push(interpolateColor(colors[0], colors[1], i / (steps - 1)));
        }
    } else if (colors.length === 3) {
        const half = Math.floor(steps / 2);
        for (let i = 0; i < half; i++) {
            gradient.push(interpolateColor(colors[0], colors[1], i / (half - 1)));
        }
        for (let i = 0; i < (steps - half); i++) {
            gradient.push(interpolateColor(colors[1], colors[2], i / ((steps - half) - 1)));
        }
    }
    return gradient;
}

function rgbaToHex(r, g, b, a) {
    const outR = Math.round((1 - a) * 255 + a * r);
    const outG = Math.round((1 - a) * 255 + a * g);
    const outB = Math.round((1 - a) * 255 + a * b);
    return "#" + [outR, outG, outB].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
}

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('[id^="btn-"]').forEach(btn => btn.classList.remove('tab-active'));
    document.getElementById('tab-' + id).classList.add('active');
    document.getElementById('btn-' + id).classList.add('tab-active');
    if (id === 'preview') { setTimeout(() => { updateAll(); }, 100); }
}

function setModeDefaults() {
    const isDark = document.getElementById('baseMode').value === 'dark';
    const primary = document.getElementById('primaryColor').value;
    const brightAdj = parseInt(document.getElementById('bgBrightness').value) || 0;
    const r = parseInt(primary.slice(1,3), 16), g = parseInt(primary.slice(3,5), 16), b = parseInt(primary.slice(5,7), 16);

    // Calculate structural defaults based on mode/primary
    let bg = isDark ? "#121214" : rgbaToHex(r, g, b, 0.04);
    if (isDark && brightAdj !== 0) bg = adjustBrightness(bg, brightAdj);

    const fg = isDark ? "#E2E8F0" : "#2C3E50";

    // Derive other colors from bg to ensure consistency (no hardcoded hexes)
    const banded = isDark ? adjustBrightness(bg, 5) : adjustBrightness(bg, -5);
    const borderColor = isDark ? adjustBrightness(bg, 15) : adjustBrightness(bg, -10);

    const slHover = isDark ? adjustBrightness(bg, 10) : adjustBrightness(bg, -3);
    const slSelect = isDark ? adjustBrightness(bg, 20) : rgbaToHex(r, g, b, 0.15);
    const slSlider = isDark ? adjustBrightness(bg, 15) : adjustBrightness(bg, -10);

    document.getElementById('tableBg').value = bg;
    document.getElementById('tableFg').value = fg;
    document.getElementById('tableBanded').value = banded;
    document.getElementById('borderColor').value = borderColor;

    document.getElementById('slicerHoverColor').value = slHover;
    document.getElementById('slicerSelectedColor').value = slSelect;
    document.getElementById('slicerSliderColor').value = slSlider;

    if (document.getElementById('autoSync') && document.getElementById('autoSync').checked) {
        syncThemeFromAccent();
    } else {
        document.getElementById('pageBg').value = bg;
        document.getElementById('pageFg').value = fg;
    }
    updateAll();
}

function syncThemeFromAccent() {
    const autoSync = document.getElementById('autoSync').checked;
    if (!autoSync) return;

    const isDark = document.getElementById('baseMode').value === 'dark';
    const accent = document.getElementById('primaryColor').value;
    const brightAdj = parseInt(document.getElementById('bgBrightness').value) || 0;
    const r = parseInt(accent.slice(1,3), 16), g = parseInt(accent.slice(3,5), 16), b = parseInt(accent.slice(5,7), 16);

    let bg, fg, banded, grid, border, slHover, slSelect, slSlider;
    if (isDark) {
        bg = adjustBrightness(accent, -90 + brightAdj);
        fg = adjustBrightness(accent, 90);
        banded = adjustBrightness(bg, 5);
        grid = adjustBrightness(bg, 15);
        border = adjustBrightness(bg, 20);
        slHover = adjustBrightness(bg, 10);
        slSelect = adjustBrightness(bg, 20);
        slSlider = adjustBrightness(bg, 15);
    } else {
        bg = rgbaToHex(r, g, b, 0.04);
        fg = adjustBrightness(accent, -80);
        banded = adjustBrightness(bg, -5);
        grid = adjustBrightness(bg, -10);
        border = adjustBrightness(bg, -15);
        slHover = adjustBrightness(bg, -3);
        slSelect = rgbaToHex(r, g, b, 0.15);
        slSlider = adjustBrightness(bg, -10);
    }
    document.getElementById('pageBg').value = bg;
    document.getElementById('pageFg').value = fg;

    document.getElementById('tableBg').value = bg;
    document.getElementById('tableFg').value = fg;
    document.getElementById('tableBanded').value = banded;

    document.getElementById('slicerHoverColor').value = slHover;
    document.getElementById('slicerSelectedColor').value = slSelect;
    document.getElementById('slicerSliderColor').value = slSlider;

    if(document.getElementById('chartLabelsColor')) document.getElementById('chartLabelsColor').value = fg;
    if(document.getElementById('xAxisLabelColor')) document.getElementById('xAxisLabelColor').value = fg;
    if(document.getElementById('yAxisLabelColor')) document.getElementById('yAxisLabelColor').value = fg;

    if(document.getElementById('borderColor')) document.getElementById('borderColor').value = border;
    if(document.getElementById('xAxisGridColor')) document.getElementById('xAxisGridColor').value = grid;
    if(document.getElementById('yAxisGridColor')) document.getElementById('yAxisGridColor').value = grid;
}

function updateAll() {
    const barEl = document.getElementById('barChart');
    const lineEl = document.getElementById('lineChart');
    const pieEl = document.getElementById('pieChart');

    if (barEl && !chartsInstance.bar) chartsInstance.bar = echarts.init(barEl);
    if (lineEl && !chartsInstance.line) chartsInstance.line = echarts.init(lineEl);
    if (pieEl && !chartsInstance.pie) chartsInstance.pie = echarts.init(pieEl);

    // Inputs
    const primary = document.getElementById('primaryColor').value;
    const font = document.getElementById('masterFont').value;
    const palette = (customColors.length > 0) ? customColors : [primary, ...palettes[selectedIdx].colors.slice(1, 8)];
    
    // Structural Colors from Inputs
    const bgHex = document.getElementById('tableBg').value;
    const pageBgHex = document.getElementById('pageBg').value;
    const fg = document.getElementById('pageFg').value;
    const brdColor = document.getElementById('borderColor').value;

    document.body.style.backgroundColor = pageBgHex;
    document.getElementById('canvas').style.backgroundColor = bgHex;
    document.getElementById('canvas').style.color = fg;

    document.querySelectorAll('.preview-card').forEach(card => {
        card.style.backgroundColor = bgHex;
        card.style.borderColor = brdColor;
    });

    const opt = { 
        textStyle: { color: fg, fontFamily: font }, 
        color: palette, 
        animation: false,
        xAxis: { type: 'category', axisLabel: { color: fg } },
        yAxis: { type: 'value', axisLabel: { color: fg } }
    };
    if (chartsInstance.bar) chartsInstance.bar.setOption({...opt, xAxis: {data: ['N','S','E','W','NW','SE','NE','SW']}, series: [{data: [15,28,12,30,22,18,25,14], type: 'bar', itemStyle: { color: (params) => palette[params.dataIndex % palette.length] }}]});
    if (chartsInstance.line) chartsInstance.line.setOption({...opt, xAxis: {data: ['Q1','Q2','Q3','Q4']}, series: [{data: [10,22,18,35], type: 'line', smooth: true}]});
    if (chartsInstance.pie) chartsInstance.pie.setOption({...opt, xAxis: null, yAxis: null, series: [{type: 'pie', radius: '60%', data: [{value: 30, name: 'Audit'}, {value: 25, name: 'Tax'}, {value: 20, name: 'Legal'}, {value: 15, name: 'HR'}, {value: 10, name: 'IT'}, {value: 8, name: 'Ops'}, {value: 5, name: 'Mkt'}, {value: 3, name: 'R&D'}]}]});

    const tableBg = document.getElementById('tableBg').value;
    const tableFg = document.getElementById('tableFg').value;
    const tableBanded = document.getElementById('tableBanded').value;

    const hCon = document.getElementById('headerContrast').checked;
    const tCon = document.getElementById('totalContrast').checked;
    const isBanded = document.getElementById('bandedRows').checked;
    const gridEnabled = document.getElementById('showGrid').checked;

    const hBg = hCon ? primary : tableBg;
    const hTxt = hCon ? bgHex : tableFg;
    const tBg = tCon ? primary : tableBg;
    const tTxt = tCon ? bgHex : tableFg;

    document.getElementById('tableHead').style.background = hBg;
    document.getElementById('tableHead').style.color = hTxt;
    document.getElementById('tableTotal').style.background = tBg;
    document.getElementById('tableTotal').style.color = tTxt;
    
    const rowPriBg = tableBg;
    const rowSecBg = isBanded ? tableBanded : rowPriBg;
    document.querySelector('#previewTable tbody tr:nth-child(1)').style.background = rowPriBg;
    document.querySelector('#previewTable tbody tr:nth-child(2)').style.background = rowSecBg;

    document.querySelectorAll('#previewTable th, #previewTable td').forEach(e => {
        e.style.borderColor = gridEnabled ? brdColor : "transparent";
        e.style.fontFamily = font;
    });

    renderInspector(palette);
    const fullJson = buildTheme(palette, bgHex, fg, null, primary, font);
    document.getElementById('jsonOut').innerText = JSON.stringify(fullJson, null, 4);
}

function buildTheme(pal, bg, fg, dark, primary, font) {
    const border = document.getElementById('showBorders').checked;
    const rad = parseInt(document.getElementById('borderRadius').value);
    const borderColor = document.getElementById('borderColor').value;
    
    // New inputs
    const showTooltip = document.getElementById('showHeaderTooltip').checked;
    const showOptionsMenu = document.getElementById('showHeaderOptions').checked;
    
    const grid = document.getElementById('showGrid').checked;
    const gridPadding = parseInt(document.getElementById('gridPadding').value);
    const textSize = parseInt(document.getElementById('gridTextSize').value);
    
    const banded = document.getElementById('bandedRows').checked;
    const urlIcon = document.getElementById('urlIcon').checked;
    const wordWrap = document.getElementById('wordWrap').checked;
    const autoSize = document.getElementById('autoSizeCol').checked;
    
    const tableBg = document.getElementById('tableBg').value;
    const tableFg = document.getElementById('tableFg').value;
    const tableBanded = document.getElementById('tableBanded').value;

    const hCon = document.getElementById('headerContrast').checked;
    const tCon = document.getElementById('totalContrast').checked;
    const sCon = document.getElementById('slicerHeaderContrast') ? document.getElementById('slicerHeaderContrast').checked : false;
    
    const stepped = document.getElementById('steppedLayout').checked;
    const steppedIndent = parseInt(document.getElementById('steppedIndent').value);
    const rowSub = document.getElementById('rowSubtotals').checked;
    const colSub = document.getElementById('colSubtotals').checked;
    
    // Chart inputs
    const legShow = document.getElementById('chartLegendShow').checked;
    const legPos = document.getElementById('chartLegendPos').value;
    const lblShow = document.getElementById('chartLabelsShow').checked;
    const lblPos = document.getElementById('chartLabelsPos').value;
    const lblCol = document.getElementById('chartLabelsColor').value;
    
    const solid = (c) => ({ "solid": { "color": c } });

    const catAx = [{
        "show": document.getElementById('xAxisShow').checked,
        "labelColor": solid(document.getElementById('xAxisLabelColor').value),
        "titleColor": solid(fg),
        "fontSize": 9, "fontFamily": font,
        "gridLineShow": document.getElementById('xAxisGrid').checked,
        "gridLineColor": solid(document.getElementById('xAxisGridColor').value),
        "gridLineThickness": 1
    }];
    const valAx = [{
        "show": document.getElementById('yAxisShow').checked,
        "labelColor": solid(document.getElementById('yAxisLabelColor').value),
        "titleColor": solid(fg),
        "fontSize": 9, "fontFamily": font,
        "gridLineShow": document.getElementById('yAxisGrid').checked,
        "gridLineColor": solid(document.getElementById('yAxisGridColor').value),
        "gridLineThickness": 1
    }];

    const hBg = solid(hCon ? primary : tableBg);
    const hTxt = solid(hCon ? bg : tableFg);
    
    // Table Totals Logic (Fixed)
    const tBg = solid(tCon ? primary : tableBg);
    const tTxt = solid(tCon ? bg : tableFg);
    
    // Slicer Header Logic
    const sBg = solid(sCon ? primary : bg);
    const sTxt = solid(sCon ? "#FFFFFF" : fg);
    
    const rowPri = solid(tableBg);
    const rowSec = banded ? solid(tableBanded) : solid(tableBg);

    // Read Slicer & Status Inputs
    const slHover = document.getElementById('slicerHoverColor').value;
    const slSelect = document.getElementById('slicerSelectedColor').value;
    const slSlider = document.getElementById('slicerSliderColor').value;

    const good = document.getElementById('statusGood').value;
    const neutral = document.getElementById('statusNeutral').value;
    const bad = document.getElementById('statusBad').value;

    // FULL 14KB+ SCHEMA (Exact match to LightTheme01.json structure)
    return {
        "name": document.getElementById('clientName').value || "Finance BI Master Theme v3e",
        "dataColors": pal,
        "tableAccent": primary,
        "background": bg,
        "foreground": fg,
        "good": good, "neutral": neutral, "bad": bad,
        "visualStyles": {
            "*": { "*": {
                "title": [{ "show": false }],
                "background": [{ "show": true, "color": solid(bg), "transparency": 0 }],
                "border": [{ "show": border, "radius": rad, "color": solid(borderColor) }],
                "visualHeader": [{ "show": true, "showTooltipButton": showTooltip, "showOptionsMenu": showOptionsMenu }]
            }},
            "tableEx": { "*": {
                "grid": [{ "rowPadding": gridPadding, "textSize": textSize, "gridVertical": grid, "gridHorizontal": grid }],
                "columnHeaders": [{ "fontColor": hTxt, "backColor": hBg, "fontFace": font, "textSize": textSize, "alignment": "Left", "wordWrap": wordWrap, "autoSizeColumnWidth": autoSize }],
                "values": [{ "fontFamily": font, "fontSize": textSize-1, "fontColorPrimary": solid(tableFg), "backColorPrimary": rowPri, "fontColorSecondary": solid(tableFg), "backColorSecondary": rowSec, "urlIcon": urlIcon, "wordWrap": wordWrap }],
                "total": [{ "totals": true, "label": "Total", "fontColor": tTxt, "backColor": tBg, "applyToHeaders": false, "fontFamily": font, "fontSize": textSize }]
            }},
            "matrix": { "*": {
                "grid": [{ "rowPadding": gridPadding, "textSize": textSize, "gridVertical": grid, "gridHorizontal": grid }],
                "columnHeaders": [{ "fontColor": hTxt, "backColor": hBg, "fontFace": font, "textSize": textSize, "alignment": "Left", "wordWrap": wordWrap }],
                "rowHeaders": [{ "fontColor": solid(tableFg), "backColor": rowPri, "stepped": stepped, "steppedLayoutIndentation": steppedIndent, "showExpandCollapseButtons": true, "expandCollapseButtonsColor": solid(fg), "fontFamily": font, "fontSize": textSize-1 }],
                "values": [{ "fontFamily": font, "fontSize": textSize-1, "fontColorPrimary": solid(tableFg), "backColorPrimary": rowPri, "fontColorSecondary": solid(tableFg), "backColorSecondary": rowSec, "bandedRowHeaders": banded, "urlIcon": urlIcon, "wordWrap": wordWrap }],
                "subTotals": [{ "rowSubTotals": rowSub, "columnSubTotals": colSub, "fontColor": tTxt, "backColor": tBg, "applyToHeaders": false, "fontFamily": font, "fontSize": textSize, "rowSubTotalPosition": "Bottom" }],
                "rowTotal": [{ "fontColor": tTxt, "backColor": tBg, "fontSize": textSize+1 }],
                "columnTotal": [{ "fontColor": tTxt, "backColor": tBg, "fontSize": textSize+1 }],
                "total": [{ "totals": true, "fontColor": tTxt, "backColor": tBg, "fontFamily": font, "fontSize": textSize+1 }]
            }},
            "slicer": { "*": {
                "header": [{ "show": true, "fontColor": sTxt, "background": sBg, "outline": "None", "textSize": 11, "fontFamily": font }],
                "items": [{ "fontColor": solid(fg), "backgroundColor": rowPri, "hoverColor": solid(slHover), "selectedColor": solid(slSelect), "outline": "None", "textSize": 10, "fontFamily": font }],
                "numericInputStyle": [{ "fontColor": solid(fg), "background": rowPri, "outline": "None", "textSize": 10, "fontFamily": font }],
                "date": [{ "fontColor": solid(fg), "background": rowPri, "textSize": 10, "fontFamily": font }],
                "slider": [{ "show": true, "background": solid(slSlider) }],
                "background": [{ "show": true, "color": solid(bg), "transparency": 0 }],
                "general": [{ "outlineColor": solid(primary), "outlineWeight": 1, "responsive": false }]
            }},
            "advancedSlicerVisual": { "*": {
                "background": [{ "show": true, "color": solid(bg), "transparency": 0 }],
                "fillCustom": [{ "$id": "default", "fillColor": rowPri }],
                "value": [{ "$id": "default", "textWrap": true, "color": solid(fg) }],
                "outline": [{ "$id": "default", "lineColor": solid(primary), "transparency": 20 }],
                "states": [{ "selectedColor": solid(slSelect), "hoverColor": solid(slHover) }]
            }},
            "barChart": { "*": { "legend": [{ "show": legShow, "position": legPos }], "labels": [{ "show": lblShow, "labelPosition": lblPos, "fontSize": 9, "fontFamily": font, "color": solid(lblCol) }], "categoryAxis": catAx, "valueAxis": valAx, "series": [{ "colors": pal }] }},
            "clusteredBarChart": { "*": { "legend": [{ "show": legShow }], "labels": [{ "show": lblShow, "labelPosition": lblPos, "fontSize": 9, "fontFamily": font, "color": solid(lblCol) }], "categoryAxis": catAx, "valueAxis": valAx, "series": [{ "colors": pal }] }},
            "columnChart": { "*": { "legend": [{ "show": legShow }], "labels": [{ "show": lblShow, "labelPosition": lblPos, "fontSize": 9, "fontFamily": font, "color": solid(lblCol) }], "categoryAxis": catAx, "valueAxis": valAx, "series": [{ "colors": pal }] }},
            "clusteredColumnChart": { "*": { "legend": [{ "show": legShow }], "labels": [{ "show": lblShow, "labelPosition": lblPos, "fontSize": 9, "fontFamily": font, "color": solid(lblCol) }], "categoryAxis": catAx, "valueAxis": valAx, "series": [{ "colors": pal }] }},
            "lineChart": { "*": { "legend": [{ "show": legShow }], "lineStyles": [{ "strokeWidth": 2, "showMarker": true }], "categoryAxis": catAx, "valueAxis": valAx, "series": [{ "colors": pal }] }},
            "areaChart": { "*": { "legend": [{ "show": legShow }], "lineStyles": [{ "strokeWidth": 2 }], "categoryAxis": catAx, "valueAxis": valAx, "series": [{ "colors": pal }] }},
            "pieChart": { "*": { "labels": [{ "show": true, "labelStyle": "Category, data value, percent of total", "fontFamily": font, "fontSize": 9, "color": solid(fg) }] }},
            "donutChart": { "*": { "labels": [{ "show": true, "labelStyle": "Category, data value, percent of total", "fontFamily": font, "fontSize": 9, "color": solid(fg) }], "slices": [{ "innerRadiusRatio": 35 }] }}
        }
    };
}


function renderInspector(pal) {
    const insp = document.getElementById('paletteInspector'); 
    if (insp) {
        insp.innerHTML = "";
        pal.forEach((c, i) => {
            const d = document.createElement('div');
            d.innerHTML = `<input type="color" value="${c}" onchange="updateCustomColor(${i}, this.value)" class="color-input-ui">`;
            insp.appendChild(d);
        });
    }
}

function updateCustomColor(i, color) {
    if (customColors.length === 0) customColors = [...palettes[selectedIdx].colors];
    customColors[i] = color; updateAll();
}

function initPalettes() {
    const container = document.getElementById('paletteGrid');
    if (!container) return;

    container.innerHTML = "";
    container.className = "space-y-6";

    let globalIdx = 0;

    for (const [groupName, groupPalettes] of Object.entries(paletteGroups)) {
        const header = document.createElement('h3');
        header.className = "text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 border-b pb-1";
        header.innerText = groupName;
        container.appendChild(header);

        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3";

        groupPalettes.forEach((p) => {
            const currentIdx = globalIdx;
            const btn = document.createElement('div');
            const isSelected = (currentIdx === selectedIdx);

            btn.className = `p-2 rounded border-2 cursor-pointer bg-white transition-all ${isSelected ? 'border-blue-500 shadow-lg scale-105' : 'border-transparent'}`;

            btn.onclick = () => {
                selectedIdx = currentIdx;
                customColors = [];
                updateAll();
                initPalettes();
            };

            btn.innerHTML = `<div class="flex h-3 mb-1 overflow-hidden rounded">${p.colors.slice(0,8).map(c=>`<div class="flex-1" style="background:${c}"></div>`).join('')}</div><span class="text-[8px] uppercase font-bold">${p.name}</span>`;

            grid.appendChild(btn);
            globalIdx++;
        });

        container.appendChild(grid);
    }
}

window.onload = () => { initPalettes(); setModeDefaults(); setTimeout(updateAll, 200); };

function downloadJSON() {
    try {
        const raw = document.getElementById('jsonOut').innerText;
        const obj = JSON.parse(raw);
        const data = JSON.stringify(obj, null, 4);
        const blob = new Blob([data], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `FinanceBI_Master_Validated.json`; a.click();
    } catch(e) {
        alert("Error generating JSON");
    }
}
</script>
</body>
</html>
